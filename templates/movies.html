<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Organizer - Movies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        :root {
            --dark-bg: #1a1b1e;
            --darker-bg: #141517;
            --dark-surface: #2a2b2e;
            --dark-border: #363940;
            --dark-text: #e4e6eb;
            --dark-text-secondary: #b0b3b8;
            --dark-hover: #2d2e32;
            --accent-color: #4f46e5;
            --accent-hover: #6366f1;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .navbar {
            background-color: var(--darker-bg) !important;
            border-bottom: 1px solid var(--dark-border);
        }

        .navbar-brand, .nav-link {
            color: var(--dark-text) !important;
        }

        .nav-link:hover {
            color: var(--accent-color) !important;
        }

        .table {
            color: var(--dark-text) !important;
            background-color: var(--dark-surface) !important;
            border-color: var(--dark-border);
        }

        .table > :not(caption) > * > * {
            background-color: var(--dark-surface) !important;
            border-bottom-color: var(--dark-border);
            color: var(--dark-text) !important;
        }

        .table > thead {
            background-color: var(--darker-bg) !important;
        }

        .table > thead th {
            background-color: var(--darker-bg) !important;
            color: var(--dark-text) !important;
            font-weight: 600;
            border-bottom: 2px solid var(--dark-border);
        }

        .table > tbody > tr {
            background-color: var(--dark-surface) !important;
        }

        .table > tbody > tr > td {
            background-color: var(--dark-surface) !important;
        }

        .table-hover tbody tr:hover {
            background-color: var(--dark-hover) !important;
        }

        .table-hover tbody tr:hover td {
            background-color: var(--dark-hover) !important;
            color: var(--dark-text) !important;
        }

        .table td, .table th {
            color: var(--dark-text) !important;
        }

        .table {
            color: var(--dark-text) !important;
        }

        .table > :not(caption) > * > * {
            color: var(--dark-text) !important;
        }

        .table-hover tbody tr:hover {
            background-color: var(--dark-hover) !important;
            color: var(--dark-text);
        }

        .dropdown-menu {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.3);
        }

        .dropdown-item {
            color: var(--dark-text);
        }

        .dropdown-item:hover {
            background-color: var(--dark-hover);
            color: var(--dark-text);
        }

        .dropdown-header {
            color: var(--dark-text-secondary);
        }

        .dropdown-divider {
            border-top-color: var(--dark-border);
        }

        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .btn-link {
            color: var(--accent-color);
        }

        .btn-link:hover {
            color: var(--accent-hover);
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-text-secondary);
        }

        /* Form controls */
        .form-control {
            background-color: var(--darker-bg);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }

        .form-control:focus {
            background-color: var(--darker-bg);
            border-color: var(--accent-color);
            color: var(--dark-text);
            box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25);
        }

        /* Alerts and notifications */
        .alert {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }

        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        /* Loading spinner */
        .spinner-border {
            border-color: var(--dark-text);
            border-right-color: transparent;
        }

        /* Modal styling */
        .modal-content {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .modal-header {
            border-bottom-color: var(--dark-border);
        }

        .modal-footer {
            border-top-color: var(--dark-border);
        }

        /* Card styling */
        .card {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .card-header {
            background-color: var(--darker-bg);
            border-bottom-color: var(--dark-border);
        }

        /* Toast styling */
        .toast {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .toast-header {
            background-color: var(--darker-bg);
            color: var(--dark-text);
        }

        /* Table styles */
        .table {
            width: 100%;
        }

        /* Sort styles */
        .sortable {
            position: relative;
            padding-right: 18px;
            cursor: pointer;
        }
        
        .sort-indicator {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .sort-indicator::after {
            content: '⇕';
            color: #999;
        }
        
        .sortable.asc .sort-indicator::after {
            content: '↑';
            color: #000;
        }
        
        .sortable.desc .sort-indicator::after {
            content: '↓';
            color: #000;
        }

        /* Loading states */
        .suggestion-loading {
            display: none;
        }
        
        .loading .suggestion-button {
            display: none;
        }
        
        .loading .suggestion-loading {
            display: flex;
        }
        
        .retry-button {
            display: none;
        }
        
        .error .retry-button {
            display: inline-block;
        }
        
        .error .loading-text {
            display: none;
        }

        /* Button styles */
        .move-button, .suggestion-button {
            white-space: nowrap;
            min-width: 120px;
        }

        /* Cell alignment */
        .table td {
            vertical-align: middle;
            position: relative;
        }

        /* Dropdown styles */
        .dropdown {
            position: static;
        }

        .dropdown-menu {
            position: absolute;
            inset: auto auto auto 0;
            margin-top: 2px !important;
            z-index: 1050;
            min-width: 200px;
            background: white;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 0.25rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .dropdown-menu.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: none !important;
        }

        .dropdown-menu .dropdown-item {
            padding: 0.5rem 1rem;
            clear: both;
            font-weight: 400;
            color: #212529;
            text-align: inherit;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
        }

        .dropdown-menu .dropdown-item:hover {
            color: #1e2125;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
{% if not partial %}
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">Movie Organizer</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="/">Configuration</a>
                    <a class="nav-link active" href="/movies">Movies</a>
                </div>
            </div>
        </nav>

        <div class="row mb-4">
            <div class="col">
                {% if error_message %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Access Error</h4>
                    <p>{{ error_message }}</p>
                </div>
                {% endif %}
                
                <div class="mb-3 d-flex align-items-center">
                    <select class="form-select me-3" style="width: auto;" onchange="handleFolderChange(event)">
                        {% for folder in config.get('movie_folders', []) %}
                        <option value="{{ folder }}" {% if folder == selected_folder %}selected{% endif %}>{{ folder }}</option>
                        {% endfor %}
                    </select>
                    
                    <div class="btn-group">
                        <button type="button" id="getUncategorizedSuggestionsButton" class="btn btn-success" onclick="getUncategorizedSuggestions()">
                            Get Uncategorized Suggestions
                        </button>
                        <button type="button" id="stopSuggestionsButton" class="btn btn-danger d-none" onclick="stopGettingSuggestions()">
                            Stop Getting Suggestions
                        </button>
                        <button type="button" class="btn btn-primary ms-2" onclick="applyAllActions()">
                            Apply All Actions
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table table-hover" id="moviesTable">
                        <thead>
                            <tr>
                                <th style="width: 60%" class="sortable" onclick="sortTable(0)" data-sort-type="text">
                                    Movie Title
                                    <span class="sort-indicator"></span>
                                </th>
                                <th style="width: 15%" class="sortable" onclick="sortTable(1)" data-sort-type="text">
                                    Current Genre
                                    <span class="sort-indicator"></span>
                                </th>
                                <th style="width: 15%">Suggested Genre</th>
                                <th style="width: 10%" class="text-end">Actions</th>
                            </tr>
                        </thead>
{% endif %}
            <tbody>
                {% for movie in movies %}
                <tr>
                    <td class="movie-title">
                        <div class="d-flex align-items-center">
                            <span class="me-2">{{ movie.title }}</span>
                            <button type="button" 
                                class="btn btn-link btn-sm p-0 info-button" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="right"
                                data-bs-title="{{ movie.path }}"
                                aria-label="Show file path">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td class="current-genre" id="current-genre-{{ loop.index }}">{{ movie.current_genre }}</td>
                    <td class="suggestion-cell" id="suggestion-{{ loop.index }}">
                        {% if movie.suggested_genre %}
                            <div class="d-flex align-items-center" style="width: 100%; overflow: hidden;">
                                <span class="me-2 text-truncate">{{ movie.suggested_genre }}</span>
                                <div class="dropdown">
                                    <button type="button" class="btn btn-link btn-sm p-0 edit-suggestion-button" 
                                        onclick="event.stopPropagation();"
                                        data-bs-toggle="dropdown" 
                                        data-index="{{ loop.index }}"
                                        aria-expanded="false">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <ul class="dropdown-menu p-2" style="min-width: 200px;" data-bs-popper="static">
                                        {% if movie.suggested_genre not in config.get('genres', []) %}
                                            <li>
                                                <button class="dropdown-item" onclick="handleGenreSelection('{{ movie.path }}', '{{ selected_folder }}', '{{ movie.suggested_genre }}', 'add')">
                                                    Add "{{ movie.suggested_genre }}" as new genre
                                                </button>
                                            </li>
                                        {% endif %}
                                        <li>
                                            <button class="dropdown-item" onclick="handleGenreSelection('{{ movie.path }}', '{{ selected_folder }}', '', 'custom')">
                                                Add custom genre...
                                            </button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">Existing Genres</h6></li>
                                        {% for genre in config.get('genres', []) %}
                                            <li>
                                                <button class="dropdown-item" onclick="handleGenreSelection('{{ movie.path }}', '{{ selected_folder }}', '{{ genre }}', 'select')">
                                                    {{ genre }}
                                                </button>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <input type="hidden" id="movie-path-{{ loop.index }}" value="{{ movie.path }}">
                                <input type="hidden" id="base-folder-{{ loop.index }}" value="{{ selected_folder }}">
                            </div>
                        {% else %}
                            <div class="suggestion-container">
                                <button type="button" class="btn btn-primary btn-sm suggestion-button" 
                                    data-title="{{ movie.title }}" 
                                    data-path="{{ movie.path }}"
                                    data-base-folder="{{ selected_folder }}"
                                    data-index="{{ loop.index0 }}" 
                                    id="suggestionButton-{{ loop.index0 }}">
                                    Get Suggestion
                                </button>
                                <div class="suggestion-loading">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span class="loading-text">Getting suggestion...</span>
                                </div>
                            </div>
                        {% endif %}
                    </td>
                    <td class="actions-cell text-end" id="actions-{{ loop.index }}">
                        {% if movie.suggested_genre and movie.suggested_genre in config.genres %}
                            <button type="button" class="btn btn-success btn-sm move-button" 
                                data-path="{{ movie.path }}" 
                                data-base-folder="{{ selected_folder }}" 
                                data-genre="{{ movie.suggested_genre }}">
                                <span class="button-text">Move to {{ movie.suggested_genre }}</span>
                                <div class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Moving...</span>
                                </div>
                                <span class="retry-text d-none">Try again</span>
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
{% if not partial %}
        </table>
    </div>
</div>

    <script>
        // Global variables
        let configuredGenres = {{ config.genres|tojson }};
        
        // Utility functions
        const createTimeoutController = (timeoutMs) => {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), timeoutMs);
            return { controller, timeout };
        };
        
        // Utility function for sleeping
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Event Handlers
        function handleFolderChange(event) {
            const selectedFolder = event.target.value;
            window.location.href = `/movies?selected_folder=${encodeURIComponent(selectedFolder)}`;
        }
        
        async function sortTable(columnIndex) {
            const table = document.getElementById('moviesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th.sortable');  // Only select sortable headers
            const currentHeader = headers[columnIndex];
            
            // Toggle sort direction
            const isAsc = !currentHeader.classList.contains('asc');
            
            // Remove sort classes from all headers
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            // Add appropriate sort class to current header
            currentHeader.classList.add(isAsc ? 'asc' : 'desc');
            
            // Sort the rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (columnIndex === 0) {
                    // Movie Title - Get text from the title span
                    aValue = a.querySelector('.movie-title .me-2').textContent.trim();
                    bValue = b.querySelector('.movie-title .me-2').textContent.trim();
                } else if (columnIndex === 1) {
                    // Current Genre - Get from the genre cell
                    aValue = a.querySelector('.current-genre').textContent.trim();
                    bValue = b.querySelector('.current-genre').textContent.trim();
                }
                
                // Compare values
                if (aValue === bValue) return 0;
                if (aValue === '') return 1;
                if (bValue === '') return -1;
                return isAsc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            });
            
            // Update the table
            rows.forEach(row => tbody.appendChild(row));
            
            // Save sort state
            saveTableState();
        }
        
        // Save table sort state
        function saveTableState() {
            const state = {
                sortColumn: currentSortColumn,
                sortDirection: currentSortDirection
            };
            sessionStorage.setItem('tableState', JSON.stringify(state));
        }
        
        // Restore table sort state
        function restoreTableState() {
            const savedState = JSON.parse(sessionStorage.getItem('tableState'));
            if (savedState && savedState.sortColumn >= 0) {
                currentSortColumn = savedState.sortColumn;
                currentSortDirection = savedState.sortDirection;
                sortTable(savedState.sortColumn);
            }
        }
        
        // Restore sort state on page load
        document.addEventListener('DOMContentLoaded', function() {
            restoreTableState();
        });

        async function moveMovie(moviePath, baseFolder, genre) {
            console.log('Moving movie:', { path: moviePath, baseFolder, genre });  // Debug log
            
            // Get the row that contains this movie
            const moviePathInput = document.querySelector(`input[value="${moviePath}"]`);
            if (!moviePathInput) {
                console.error('Could not find movie row');
                return;
            }
            
            const row = moviePathInput.closest('tr');
            if (!row) {
                console.error('Could not find movie row');
                return;
            }
            
            // Find the button that was clicked
            const button = row.querySelector('.move-button');
            if (!button) {
                console.error('Could not find button for path:', moviePath);
                return;
            }
            
            const buttonText = button.querySelector('.button-text');
            const spinner = button.querySelector('.spinner-border');
            const retryText = button.querySelector('.retry-text');
            
            // Show loading state
            button.disabled = true;
            buttonText.classList.add('d-none');
            spinner.classList.remove('d-none');
            retryText.classList.add('d-none');
            
            try {
                const response = await fetch('/move_movie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        movie_path: moviePath,
                        base_folder: baseFolder,
                        genre: genre
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Move response:', data);  // Debug log
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show success state
                button.className = 'btn btn-outline-success btn-sm disabled';
                button.style.minWidth = button.offsetWidth + 'px'; // Preserve button width
                button.innerHTML = '<i class="bi bi-check-lg me-1"></i>Moved';
                
                // Update the current genre cell
                const currentGenreCell = row.querySelector('td:nth-child(2)');
                if (currentGenreCell) {
                    currentGenreCell.textContent = genre;
                }
                
            } catch (error) {
                console.error('Error moving movie:', error);
                
                // Show retry state
                button.disabled = false;
                button.classList.remove('btn-success');
                button.classList.add('btn-danger');
                buttonText.classList.add('d-none');
                spinner.classList.add('d-none');
                retryText.classList.remove('d-none');
            }
        }

        async function getUncategorizedSuggestions() {
            // Find all suggestion buttons for uncategorized movies
            const uncategorizedButtons = Array.from(document.querySelectorAll('#moviesTable tbody tr')).filter(row => {
                const currentGenreCell = row.querySelector('td:nth-child(2)');
                return currentGenreCell && currentGenreCell.textContent.trim() === 'Uncategorized';
            }).map(row => row.querySelector('.suggestion-button')).filter(button => button && !button.disabled);

            const delay = 1000; // 1 second delay between requests
            
            // Show stop button, hide get button
            const getButton = document.getElementById('getUncategorizedSuggestionsButton');
            const stopButton = document.getElementById('stopSuggestionsButton');
            if (getButton && stopButton) {
                getButton.classList.add('d-none');
                stopButton.classList.remove('d-none');
            }
            
            // Set flag to true
            isGettingSuggestions = true;
            
            try {
                for (const button of uncategorizedButtons) {
                    // Check if we should stop
                    if (!isGettingSuggestions) {
                        console.log('Suggestion process stopped by user');
                        break;
                    }
                    
                    // Click the button and wait for the request to complete
                    button.click();
                    
                    // Wait before making the next request
                    await sleep(delay);
                }
            } catch (error) {
                console.error('Error getting suggestions:', error);
            } finally {
                // Reset UI state
                stopGettingSuggestions();
            }
        }
        
        // Flag to control suggestion loop
        let isGettingSuggestions = false;

        function stopGettingSuggestions() {
            isGettingSuggestions = false;
            const getButton = document.getElementById('getUncategorizedSuggestionsButton');
            const stopButton = document.getElementById('stopSuggestionsButton');
            if (getButton && stopButton) {
                getButton.classList.remove('d-none');
                stopButton.classList.add('d-none');
            }
        }

        async function getGenreSuggestion(button) {
            const container = button.closest('.suggestion-container');
            if (!container) {
                console.error('Could not find suggestion container');
                return;
            }
            
            // Add loading class to container
            container.classList.add('loading');
            
            try {
                const response = await fetch('/suggest_genre', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: button.dataset.title,
                        path: button.dataset.path,
                        base_folder: button.dataset.baseFolder
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to get suggestion');
                }
                
                const data = await response.json();
                
                // Get the cell that contains this button
                const cell = container.closest('td');
                if (!cell) {
                    throw new Error('Could not find cell');
                }
                
                const index = button.dataset.index;
                const path = button.dataset.path;
                const baseFolder = button.dataset.baseFolder;
                
                // Update the cell with the suggestion and edit button
                cell.innerHTML = `
                    <div class="d-flex align-items-center" style="width: 100%; overflow: hidden;">
                        <span class="me-2 text-truncate">${data.genre}</span>
                        <div class="dropdown">
                            <button type="button" class="btn btn-link btn-sm p-0 edit-suggestion-button" 
                                onclick="event.stopPropagation();"
                                data-bs-toggle="dropdown" 
                                data-index="${index}"
                                aria-expanded="false">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <ul class="dropdown-menu p-2" style="min-width: 200px;" data-bs-popper="static">
                                ${!configuredGenres.some(g => g.toLowerCase() === data.genre.toLowerCase()) ? `
                                    <li>
                                        <button class="dropdown-item" onclick="handleGenreSelection('${path}', '${baseFolder}', '${data.genre}', 'add')">
                                            Add "${data.genre}" as new genre
                                        </button>
                                    </li>
                                ` : ''}
                                <li>
                                    <button class="dropdown-item" onclick="handleGenreSelection('${path}', '${baseFolder}', '', 'custom')">
                                        Add custom genre...
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Existing Genres</h6></li>
                                ${configuredGenres.map(genre => `
                                    <li>
                                        <button class="dropdown-item" onclick="handleGenreSelection('${path}', '${baseFolder}', '${genre}', 'select')">
                                            ${genre}
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>`;

                // Get the current genre and update action cell if different
                const row = cell.closest('tr');
                if (!row) {
                    throw new Error('Could not find row');
                }
                
                const currentGenreCell = row.querySelector('td:nth-child(2)');
                if (!currentGenreCell) {
                    throw new Error('Could not find current genre cell');
                }
                
                const currentGenre = currentGenreCell.textContent.trim();
                if (currentGenre.toLowerCase() !== data.genre.toLowerCase()) {
                    const actionCell = row.querySelector('td:last-child');
                    if (!actionCell) {
                        throw new Error('Could not find action cell');
                    }
                    
                    actionCell.innerHTML = `
                        <button type="button" class="btn btn-success btn-sm move-button" 
                            data-path="${path}" 
                            data-base-folder="${baseFolder}" 
                            data-genre="${data.genre}">
                            <span class="button-text">Move to ${data.genre}</span>
                            <div class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden">Moving...</span>
                            </div>
                            <span class="retry-text d-none">Try again</span>
                        </button>`;
                    
                    // Attach move button listener
                    const moveButton = actionCell.querySelector('.move-button');
                    moveButton.addEventListener('click', function() {
                        moveMovie(this.dataset.path, this.dataset.baseFolder, this.dataset.genre);
                    });
                }
                
            } catch (error) {
                console.error('Error getting suggestion:', error);
                container.classList.remove('loading');
                container.classList.add('error');
            }
        }

        const suggestionButtons = document.querySelectorAll('.suggestion-button');
        suggestionButtons.forEach(button => {
            button.addEventListener('click', function() {
                getGenreSuggestion(this);
            });
        });

        function attachEditButtonListener(button) {
            if (!button) return;
            
            // Clone and replace to remove any existing listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showGenreEditForm(this);
            });
            
            return newButton;
        }
        
        function attachMoveButtonListener(button) {
            if (!button) return;
            
            // Clone and replace to remove any existing listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function() {
                const { path, baseFolder, genre } = this.dataset;
                moveMovie(path, baseFolder, genre);
            });
            
            return newButton;
        }

        async function handleGenreSelection(moviePath, baseFolder, genre, action) {
            try {
                let selectedGenre = genre;
                
                if (action === 'custom') {
                    const newGenre = prompt('Enter new genre name:');
                    if (!newGenre) return;
                    selectedGenre = newGenre.trim();
                }

                if (action === 'add' || action === 'custom') {
                    const response = await fetch('/add_genre', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            genre: selectedGenre
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to add genre');
                    }
                }

                // Find the row using the path
                const moviePathInput = document.querySelector(`input[value="${moviePath}"]`);
                if (!moviePathInput) {
                    throw new Error('Could not find movie row');
                }
                
                const row = moviePathInput.closest('tr');
                if (!row) {
                    throw new Error('Could not find movie row');
                }
                
                // Update suggested genre text
                const suggestionCell = row.querySelector('td:nth-child(3)');
                if (!suggestionCell) {
                    throw new Error('Could not find suggestion cell');
                }
                
                const genreText = suggestionCell.querySelector('span');
                if (genreText) {
                    genreText.textContent = selectedGenre;
                }

                // Update actions cell if genre is different from current
                const currentGenreCell = row.querySelector('td:nth-child(2)');
                if (!currentGenreCell) {
                    throw new Error('Could not find current genre cell');
                }
                
                const currentGenre = currentGenreCell.textContent.trim();
                if (currentGenre.toLowerCase() !== selectedGenre.toLowerCase()) {
                    const actionCell = row.querySelector('td:last-child');
                    if (!actionCell) {
                        throw new Error('Could not find action cell');
                    }
                    
                    const moveButton = document.createElement('button');
                    moveButton.type = 'button';
                    moveButton.className = 'btn btn-success btn-sm move-button';
                    moveButton.innerHTML = `
                        <span class="button-text">Move to ${selectedGenre}</span>
                        <div class="spinner-border spinner-border-sm d-none" role="status">
                            <span class="visually-hidden">Moving...</span>
                        </div>
                        <span class="retry-text d-none">Try again</span>
                    `;
                    
                    moveButton.dataset.path = moviePath;
                    moveButton.dataset.baseFolder = baseFolder;
                    moveButton.dataset.genre = selectedGenre;
                    
                    actionCell.innerHTML = '';
                    actionCell.appendChild(moveButton);
                    
                    moveButton.addEventListener('click', function() {
                        moveMovie(this.dataset.path, this.dataset.baseFolder, this.dataset.genre);
                    });
                }

                // Hide the dropdown
                const dropdown = document.querySelector('.dropdown-menu.show');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }

            } catch (error) {
                console.error('Error handling genre selection:', error);
                alert('Failed to update genre. Please try again.');
            }
        }

        function showGenreEditForm(button) {
            // Show/hide dropdown is now handled by Bootstrap
            // This function is kept for any additional functionality we might need
            return;
        }
        
        function createMoveButton(moviePath, baseFolder, genre) {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-success btn-sm move-button';
            button.innerHTML = `
                <span class="button-text">Move to ${genre}</span>
                <div class="spinner-border spinner-border-sm d-none" role="status">
                    <span class="visually-hidden">Moving...</span>
                </div>
                <span class="retry-text d-none">Try again</span>
            `;
            
            button.dataset.path = moviePath;
            button.dataset.baseFolder = baseFolder;
            button.dataset.genre = genre;
            
            button.addEventListener('click', function() {
                moveMovie(this.dataset.path, this.dataset.baseFolder, this.dataset.genre);
            });
            
            return button;
        }

        function attachEventListeners() {
            console.log('Attaching all event listeners');
            
            // Remove existing event listeners by cloning and replacing elements
            document.querySelectorAll('.suggestion-button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    getGenreSuggestion(this);
                });
            });
            
            document.querySelectorAll('.move-button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    const { path, baseFolder, genre } = this.dataset;
                    moveMovie(path, baseFolder, genre);
                });
            });
            
            document.querySelectorAll('.genre-selection select').forEach(select => {
                const newSelect = select.cloneNode(true);
                select.parentNode.replaceChild(newSelect, select);
                newSelect.addEventListener('change', function() {
                    handleGenreSelection(this);
                });
            });
            
            // Attach edit button listeners
            console.log('Looking for edit buttons');
            const editButtons = document.querySelectorAll('.edit-suggestion-button');
            console.log('Found edit buttons:', editButtons.length);
            editButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                console.log('Found edit button:', newButton);
                console.log('Button dataset:', newButton.dataset);
                newButton.addEventListener('click', function(e) {
                    console.log('Edit button clicked!');
                    console.log('Button data:', this.dataset);
                    e.preventDefault();
                    e.stopPropagation();
                    showGenreEditForm(this);
                });
            });
        }
        
        // Initial event listener attachment
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - attaching listeners');
            attachEventListeners();
        });
        
        // Initialize tooltips
        function initializeTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl, {
                    trigger: 'click',
                    html: true
                });
            });

            // Hide tooltip when clicking anywhere else
            document.addEventListener('click', function (event) {
                if (!event.target.closest('[data-bs-toggle="tooltip"]')) {
                    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                        const tooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                        if (tooltip) {
                            tooltip.hide();
                        }
                    });
                }
            });

            // Hide other tooltips when showing a new one
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                tooltipTriggerEl.addEventListener('show.bs.tooltip', function () {
                    tooltipTriggerList.forEach(function (otherTriggerEl) {
                        if (otherTriggerEl !== tooltipTriggerEl) {
                            const tooltip = bootstrap.Tooltip.getInstance(otherTriggerEl);
                            if (tooltip) {
                                tooltip.hide();
                            }
                        }
                    });
                });
            });
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTooltips();
        });
        
        // Initialize all dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap dropdowns
            var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
            var dropdownList = dropdownElementList.map(function(dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl, {
                    reference: 'parent'
                });
            });
            
            // Re-initialize dropdowns after dynamic content changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        var newDropdownElementList = [].slice.call(mutation.target.querySelectorAll('[data-bs-toggle="dropdown"]'));
                        newDropdownElementList.forEach(function(dropdownToggleEl) {
                            new bootstrap.Dropdown(dropdownToggleEl, {
                                reference: 'parent'
                            });
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
    
    <!-- Hidden inputs for movie data -->
    {% for movie in movies %}
    <input type="hidden" id="movie-path-{{ loop.index }}" value="{{ movie.path }}">
    <input type="hidden" id="base-folder-{{ loop.index }}" value="{{ selected_folder }}">
    {% endfor %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% endif %}
</body>
</html>
