<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Organizer - Movies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        .table th {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 1;
            cursor: pointer;
        }
        
        .table th:hover {
            background-color: #f8f9fa;
        }
        
        .table td {
            vertical-align: middle;
            white-space: normal;
            min-width: 0;
            max-width: none;
            overflow: visible;
        }
        
        .sortable {
            position: relative;
            padding-right: 18px;
        }
        
        .sort-indicator {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .sort-indicator::after {
            content: '⇕';
            color: #999;
        }
        
        .sortable.asc .sort-indicator::after {
            content: '↑';
            color: #000;
        }
        
        .sortable.desc .sort-indicator::after {
            content: '↓';
            color: #000;
        }
        
        .suggestion-loading {
            display: none;
        }
        
        .suggestion-container {
            min-width: 120px;
            display: inline-block;
        }
        
        .edit-suggestion-button {
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .edit-suggestion-button:hover {
            opacity: 1;
        }
        
        /* Ensure consistent button sizes */
        .btn-sm {
            min-width: 100px;
        }
        
        /* Make sure the action buttons don't wrap */
        .move-button {
            white-space: nowrap;
            min-width: 150px;
        }
        
        /* Ensure consistent width for suggestion buttons */
        .suggestion-button {
            min-width: 120px;
        }
        
        /* Keep edit form consistent width */
        .edit-genre-select {
            min-width: 200px;
            max-width: 300px;
        }
        
        /* Handle long movie titles */
        .movie-title {
            word-break: break-word;
            max-width: 100%;
            display: block;
        }
        
        .info-button {
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .info-button:hover {
            opacity: 1;
        }
        
        /* Style the tooltip */
        .tooltip {
            font-family: monospace;
            max-width: none;
        }
        
        .tooltip-inner {
            max-width: none;
            background-color: #2c3e50;
            padding: 8px 12px;
        }
    </style>
</head>
<body>
{% if not partial %}
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">Movie Organizer</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="/">Configuration</a>
                    <a class="nav-link active" href="/movies">Movies</a>
                </div>
            </div>
        </nav>

        <div class="row mb-4">
            <div class="col">
                {% if error_message %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Access Error</h4>
                    <p>{{ error_message }}</p>
                </div>
                {% endif %}
                
                <div class="mb-3 d-flex align-items-center">
                    <select class="form-select me-3" style="width: auto;" onchange="handleFolderChange(event)">
                        {% for folder in config.get('movie_folders', []) %}
                        <option value="{{ folder }}" {% if folder == selected_folder %}selected{% endif %}>{{ folder }}</option>
                        {% endfor %}
                    </select>
                    
                    <div class="btn-group">
                        <button type="button" id="getUncategorizedSuggestionsButton" class="btn btn-success" onclick="getUncategorizedSuggestions()">
                            Get Uncategorized Suggestions
                        </button>
                        <button type="button" id="stopSuggestionsButton" class="btn btn-danger d-none" onclick="stopGettingSuggestions()">
                            Stop Getting Suggestions
                        </button>
                        <button type="button" class="btn btn-primary ms-2" onclick="applyAllActions()">
                            Apply All Actions
                        </button>
                    </div>
                </div>

                <table class="table table-hover" id="moviesTable">
                    <thead>
                        <tr>
                            <th style="width: 60%" class="sortable" onclick="sortTable(0)" data-sort-type="text">
                                Movie Title
                                <span class="sort-indicator"></span>
                            </th>
                            <th style="width: 15%" class="sortable" onclick="sortTable(1)" data-sort-type="text">
                                Current Genre
                                <span class="sort-indicator"></span>
                            </th>
                            <th style="width: 15%">Suggested Genre</th>
                            <th style="width: 10%" class="text-end">Actions</th>
                        </tr>
                    </thead>
{% endif %}
            <tbody>
                {% for movie in movies %}
                <tr>
                    <td class="text-break movie-title">
                        <div class="d-flex align-items-center">
                            <span class="me-2">{{ movie.title }}</span>
                            <button type="button" 
                                class="btn btn-link btn-sm p-0 info-button" 
                                data-bs-toggle="tooltip" 
                                data-bs-placement="right"
                                data-bs-title="{{ movie.path }}"
                                aria-label="Show file path">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td id="current-genre-{{ loop.index }}">{{ movie.current_genre }}</td>
                    <td id="suggestion-{{ loop.index }}">
                        {% if movie.suggested_genre %}
                            <div class="d-flex align-items-center">
                                <span class="me-2">{{ movie.suggested_genre }}</span>
                                <button type="button" class="btn btn-link btn-sm p-0 edit-suggestion-button" 
                                    data-movie-path="{{ movie.path }}"
                                    data-base-folder="{{ selected_folder }}"
                                    data-current-genre="{{ movie.suggested_genre }}"
                                    data-index="{{ loop.index }}">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </div>
                        {% else %}
                            <div class="suggestion-container-{{ loop.index0 }}">
                                <button type="button" class="btn btn-primary btn-sm suggestion-button" 
                                    data-title="{{ movie.title }}" 
                                    data-path="{{ movie.path }}"
                                    data-base-folder="{{ selected_folder }}"
                                    data-index="{{ loop.index0 }}" 
                                    id="suggestionButton-{{ loop.index0 }}">
                                    Get Suggestion
                                </button>
                                <div class="suggestion-loading">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span class="loading-text">Getting suggestion...</span>
                                    <button type="button" class="btn btn-link btn-sm retry-button" 
                                        data-title="{{ movie.title }}" 
                                        data-path="{{ movie.path }}"
                                        data-base-folder="{{ selected_folder }}"
                                        data-index="{{ loop.index0 }}" 
                                        id="retryButton-{{ loop.index0 }}">
                                        Try again
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        <input type="hidden" id="movie-path-{{ loop.index }}" value="{{ movie.path }}">
                        <input type="hidden" id="base-folder-{{ loop.index }}" value="{{ selected_folder }}">
                    </td>
                    <td id="actions-{{ loop.index }}" class="text-end">
                        {% if movie.suggested_genre and movie.suggested_genre in config.genres %}
                            <button type="button" class="btn btn-success btn-sm move-button" 
                                data-path="{{ movie.path }}" 
                                data-base-folder="{{ selected_folder }}" 
                                data-genre="{{ movie.suggested_genre }}">
                                <span class="button-text">Move to {{ movie.suggested_genre }}</span>
                                <div class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Moving...</span>
                                </div>
                                <span class="retry-text d-none">Try again</span>
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
{% if not partial %}
        </table>
    </div>

    <script>
        // Global variables
        let configuredGenres = {{ config.genres|tojson }};
        
        // Utility functions
        const createTimeoutController = (timeoutMs) => {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), timeoutMs);
            return { controller, timeout };
        };
        
        // Utility function for sleeping
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Event Handlers
        async function handleFolderChange(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('Folder select changed');
            
            const selectedFolder = event.target.value;
            console.log('Selected folder:', selectedFolder);
            
            try {
                const response = await fetch(`/movies?selected_folder=${encodeURIComponent(selectedFolder)}&partial=true`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const html = await response.text();
                
                // Update the table body with the new content
                const tableBody = document.querySelector('#moviesTable tbody');
                tableBody.innerHTML = html;
                
                // Update URL without reloading
                const url = new URL(window.location);
                url.searchParams.set('selected_folder', selectedFolder);
                window.history.pushState({}, '', url);
                
                // Reattach event listeners
                console.log('Reattaching event listeners after folder change');
                attachEventListeners();
                
            } catch (error) {
                console.error('Error updating folder content:', error);
                alert('Error updating folder content. Please try again.');
            }
            
            return false;
        }
        
        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - attaching listeners');
            
            // Attach folder change handler
            const folderSelect = document.getElementById('folderSelect');
            if (folderSelect) {
                folderSelect.addEventListener('change', handleFolderChange);
            }
            
            // Attach all other listeners
            attachEventListeners();
        });
        
        // Sort state tracking
        let currentSortColumn = -1;
        let currentSortDirection = 'asc';

        function sortTable(columnIndex) {
            const table = document.getElementById('moviesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('th.sortable');  // Only select sortable headers
            const currentHeader = headers[columnIndex];
            
            // Toggle sort direction
            const isAsc = !currentHeader.classList.contains('asc');
            
            // Remove sort classes from all headers
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            // Add appropriate sort class to current header
            currentHeader.classList.add(isAsc ? 'asc' : 'desc');
            
            // Sort the rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (columnIndex === 0) {
                    // Movie Title - Get from the first cell
                    aValue = a.cells[0].textContent.trim();
                    bValue = b.cells[0].textContent.trim();
                } else if (columnIndex === 1) {
                    // Current Genre - Get from the genre span
                    aValue = a.querySelector('[id^="current-genre-"]').textContent.trim();
                    bValue = b.querySelector('[id^="current-genre-"]').textContent.trim();
                }
                
                // Compare values
                if (aValue === bValue) return 0;
                if (aValue === '') return 1;
                if (bValue === '') return -1;
                return isAsc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            });
            
            // Update the table
            rows.forEach(row => tbody.appendChild(row));
            
            // Save sort state
            saveTableState();
        }
        
        // Save table sort state
        function saveTableState() {
            const state = {
                sortColumn: currentSortColumn,
                sortDirection: currentSortDirection
            };
            sessionStorage.setItem('tableState', JSON.stringify(state));
        }
        
        // Restore table sort state
        function restoreTableState() {
            const savedState = JSON.parse(sessionStorage.getItem('tableState'));
            if (savedState && savedState.sortColumn >= 0) {
                currentSortColumn = savedState.sortColumn;
                currentSortDirection = savedState.sortDirection;
                sortTable(savedState.sortColumn);
            }
        }
        
        // Restore sort state on page load
        document.addEventListener('DOMContentLoaded', function() {
            restoreTableState();
        });

        async function moveMovie(path, baseFolder, genre) {
            console.log('Moving movie:', { path, baseFolder, genre });  // Debug log
            
            // Get the row that contains this movie
            const moviePath = decodeURIComponent(path);
            const baseFolderPath = decodeURIComponent(baseFolder);
            
            // Find the button that was clicked
            const button = document.querySelector(`button[data-path="${path}"]`);
            if (!button) {
                console.error('Could not find button for path:', path);
                return;
            }
            
            const buttonText = button.querySelector('.button-text');
            const spinner = button.querySelector('.spinner-border');
            const retryText = button.querySelector('.retry-text');
            
            // Show loading state
            buttonText.style.display = 'none';
            spinner.classList.remove('d-none');
            retryText.classList.add('d-none');
            button.disabled = true;
            
            try {
                const response = await fetch('/move_movie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        movie_path: moviePath,
                        base_folder: baseFolderPath,
                        genre: genre
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Move response:', data);  // Debug log
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update the UI to reflect the move
                const row = button.closest('tr');
                const currentGenreCell = row.querySelector('td:nth-child(2)');
                currentGenreCell.textContent = genre;
                
                // Clear the suggestion and action cells
                const suggestionCell = row.querySelector('td:nth-child(3)');
                const actionCell = row.querySelector('td:last-child');
                suggestionCell.textContent = '';
                actionCell.textContent = 'Moved successfully';
                
            } catch (error) {
                console.error('Error moving movie:', error);
                
                // Show retry state
                buttonText.style.display = 'none';
                spinner.classList.add('d-none');
                retryText.classList.remove('d-none');
                button.disabled = false;
                
                // Show error message
                const row = button.closest('tr');
                const actionCell = row.querySelector('td:last-child');
                actionCell.innerHTML = `
                    <div class="text-danger mb-2">${error.message}</div>
                    <button type="button" class="btn btn-warning btn-sm" onclick="moveMovie('${path}', '${baseFolder}', '${genre}')">
                        Try Again
                    </button>`;
            }
        }

        async function getUncategorizedSuggestions() {
            // Find all suggestion buttons for uncategorized movies
            const uncategorizedButtons = Array.from(document.querySelectorAll('#moviesTable tbody tr')).filter(row => {
                const currentGenreCell = row.querySelector('td:nth-child(2)');
                return currentGenreCell && currentGenreCell.textContent.trim() === 'Uncategorized';
            }).map(row => row.querySelector('.suggestion-button')).filter(button => button && !button.disabled);

            const delay = 1000; // 1 second delay between requests
            
            // Show stop button, hide get button
            const getButton = document.getElementById('getUncategorizedSuggestionsButton');
            const stopButton = document.getElementById('stopSuggestionsButton');
            if (getButton && stopButton) {
                getButton.classList.add('d-none');
                stopButton.classList.remove('d-none');
            }
            
            // Set flag to true
            isGettingSuggestions = true;
            
            try {
                for (const button of uncategorizedButtons) {
                    // Check if we should stop
                    if (!isGettingSuggestions) {
                        console.log('Suggestion process stopped by user');
                        break;
                    }
                    
                    // Click the button and wait for the request to complete
                    button.click();
                    
                    // Wait before making the next request
                    await sleep(delay);
                }
            } catch (error) {
                console.error('Error getting suggestions:', error);
            } finally {
                // Reset UI state
                stopGettingSuggestions();
            }
        }
        
        // Flag to control suggestion loop
        let isGettingSuggestions = false;

        function stopGettingSuggestions() {
            isGettingSuggestions = false;
            const getButton = document.getElementById('getUncategorizedSuggestionsButton');
            const stopButton = document.getElementById('stopSuggestionsButton');
            if (getButton && stopButton) {
                getButton.classList.remove('d-none');
                stopButton.classList.add('d-none');
            }
        }

        async function getGenreSuggestion(button) {
            const title = button.dataset.title;
            const path = button.dataset.path;
            const baseFolder = button.dataset.baseFolder;
            const index = parseInt(button.dataset.index);
            
            console.log('Raw button data:', button.dataset);  // Debug log
            
            const container = document.querySelector(`.suggestion-container-${index}`);
            const suggestionButton = container.querySelector('.suggestion-button');
            const loading = container.querySelector('.suggestion-loading');
            const loadingText = loading.querySelector('.loading-text');
            const retryButton = loading.querySelector('.retry-button');
            const suggestionCell = document.getElementById(`suggestion-${index + 1}`);
            
            // Show loading state
            suggestionButton.style.display = 'none';
            loading.style.display = 'inline-block';
            loadingText.textContent = 'Getting suggestion...';
            retryButton.style.display = 'none';
            
            try {
                // Construct full path
                const fullPath = baseFolder + (baseFolder.endsWith('/') ? '' : '/') + path;
                const requestData = { title: fullPath };
                console.log('Sending request data:', requestData);  // Debug log
                
                const response = await fetch('/suggest_genre', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);  // Debug log
                    throw new Error(`Server error: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Genre suggestion response:', data);  // Debug log
                
                // Hide loading state
                loading.style.display = 'none';
                
                if (data.status === 'undetermined') {
                    // Handle undetermined genre
                    suggestionCell.innerHTML = `<span class="text-muted">Unable to determine genre</span>`;
                    suggestionButton.classList.add('btn-secondary');
                    suggestionButton.disabled = true;
                    suggestionButton.style.display = 'inline-block';
                    return;
                }
                
                if (data.status === 'timeout') {
                    // Handle timeout
                    suggestionCell.innerHTML = `<span class="text-warning">Request timed out. Please try again.</span>`;
                    suggestionButton.style.display = 'inline-block';
                    return;
                }
                
                if (data.error || !data.genre) {
                    // Handle error
                    suggestionCell.innerHTML = `<span class="text-danger">${data.error || 'Failed to get genre'}</span>`;
                    suggestionButton.style.display = 'inline-block';
                    return;
                }
                
                // Handle success
                const currentGenre = document.getElementById(`current-genre-${index + 1}`).textContent;
                suggestionCell.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="me-2">${data.genre}</span>
                        <button type="button" class="btn btn-link btn-sm p-0 edit-suggestion-button" 
                            data-movie-path="${path}"
                            data-base-folder="${baseFolder}"
                            data-current-genre="${data.genre}"
                            data-index="${index + 1}">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                    </div>`;
                
                // Update the actions cell if genre is different
                if (currentGenre.toLowerCase() !== data.genre.toLowerCase()) {
                    const actionsCell = document.getElementById(`actions-${index + 1}`);
                    const moviePath = document.getElementById(`movie-path-${index + 1}`).value;
                    const baseFolder = document.getElementById(`base-folder-${index + 1}`).value;
                    
                    // Case-insensitive check if genre is in configured genres
                    const genreExists = configuredGenres.some(g => g.toLowerCase() === data.genre.toLowerCase());
                    
                    if (genreExists) {
                        const buttonHtml = `
                            <button type="button" class="btn btn-success btn-sm move-button" 
                                data-path="${moviePath}" 
                                data-base-folder="${baseFolder}" 
                                data-genre="${data.genre}">
                                <span class="button-text">Move to ${data.genre}</span>
                                <div class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Moving...</span>
                                </div>
                                <span class="retry-text d-none">Try again</span>
                            </button>`;
                        actionsCell.innerHTML = buttonHtml;
                        
                        // Attach listener to new move button
                        const newMoveButton = actionsCell.querySelector('.move-button');
                        attachMoveButtonListener(newMoveButton);
                    }
                }
                
                // Attach listener to new edit button
                const newEditButton = suggestionCell.querySelector('.edit-suggestion-button');
                attachEditButtonListener(newEditButton);
                
            } catch (error) {
                console.error('Error getting suggestion:', error);
                loading.style.display = 'none';
                suggestionButton.style.display = 'inline-block';
                suggestionCell.innerHTML = `<span class="text-danger">${error.message}</span>`;
            }
        }

        const suggestionButtons = document.querySelectorAll('.suggestion-button');
        suggestionButtons.forEach(button => {
            button.addEventListener('click', function() {
                getGenreSuggestion(this);
            });
        });

        function attachEditButtonListener(button) {
            if (!button) return;
            
            // Clone and replace to remove any existing listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showGenreEditForm(this);
            });
            
            return newButton;
        }
        
        function attachMoveButtonListener(button) {
            if (!button) return;
            
            // Clone and replace to remove any existing listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function() {
                const { path, baseFolder, genre } = this.dataset;
                moveMovie(path, baseFolder, genre);
            });
            
            return newButton;
        }

        async function handleGenreSelection(selectElement) {
            console.log('handleGenreSelection called');  // Debug log
            const value = selectElement.value;
            if (!value) return;

            // Get data from data attributes
            const moviePath = selectElement.dataset.moviePath;
            const baseFolder = selectElement.dataset.baseFolder;
            
            console.log('Selection data:', { value, moviePath, baseFolder });  // Debug log

            let genre;
            if (value.startsWith('new:custom')) {
                // Show prompt for custom genre
                const customGenre = prompt('Enter new genre name:');
                if (!customGenre) {
                    selectElement.value = ''; // Reset selection
                    return;
                }
                genre = customGenre;
                // Add the new genre first
                await addNewGenre(genre);
            } else if (value.startsWith('new:')) {
                // Add the suggested new genre
                genre = value.substring(4); // Remove 'new:' prefix
                await addNewGenre(genre);
            } else if (value.startsWith('existing:')) {
                // Use existing genre
                genre = value.substring(9); // Remove 'existing:' prefix
            }

            if (genre) {
                try {
                    // Find the row and update the action cell with a move button
                    const row = selectElement.closest('tr');
                    const actionCell = row.querySelector('td:last-child');
                    
                    // Create a temporary button element to properly escape onclick
                    const tempDiv = document.createElement('div');
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-success btn-sm move-button';
                    button.setAttribute('data-path', moviePath);
                    button.setAttribute('data-base-folder', baseFolder);
                    button.setAttribute('data-genre', genre);
                    
                    const buttonText = document.createElement('span');
                    buttonText.className = 'button-text';
                    buttonText.textContent = `Move to ${genre}`;
                    button.appendChild(buttonText);
                    
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner-border spinner-border-sm d-none';
                    spinner.setAttribute('role', 'status');
                    const spinnerText = document.createElement('span');
                    spinnerText.className = 'visually-hidden';
                    spinnerText.textContent = 'Moving...';
                    spinner.appendChild(spinnerText);
                    button.appendChild(spinner);
                    
                    const retryText = document.createElement('span');
                    retryText.className = 'retry-text d-none';
                    retryText.textContent = 'Try again';
                    button.appendChild(retryText);
                    
                    // Add click handler
                    button.addEventListener('click', function() {
                        const { path, baseFolder, genre } = this.dataset;
                        moveMovie(path, baseFolder, genre);
                    });
                    
                    // Clear and update the action cell
                    actionCell.innerHTML = '';
                    actionCell.appendChild(button);
                    
                    console.log('Updated action cell successfully');  // Debug log
                } catch (error) {
                    console.error('Error updating action cell:', error);
                    // Optionally show an error message to the user
                    alert('Error updating the move button. Please try again.');
                }
            }
        }

        const genreSelects = document.querySelectorAll('.genre-selection select');
        genreSelects.forEach(select => {
            select.addEventListener('change', function() {
                handleGenreSelection(this);
            });
        });

        async function addNewGenre(newGenre) {
            try {
                const response = await fetch('/add_genre', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ genre: newGenre })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                // Refresh the page to show updated genres
                window.location.reload();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to add new genre. Please try again.');
            }
        }

        function showGenreEditForm(button) {
            console.log('Showing genre edit form', button.dataset);
            const index = button.dataset.index;
            const currentGenre = button.dataset.currentGenre;
            const suggestionCell = document.getElementById(`suggestion-${index}`);
            
            console.log('Found suggestion cell:', suggestionCell);
            console.log('Current genre:', currentGenre);
            console.log('Available genres:', configuredGenres);
            
            // Create the select element with options
            const selectHtml = `
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm edit-genre-select" 
                        data-movie-path="${button.dataset.moviePath}"
                        data-base-folder="${button.dataset.baseFolder}"
                        data-index="${index}"
                        onchange="event.preventDefault(); return false;">
                        <option value="">Select or add genre...</option>
                        <option value="new:custom">Add custom genre...</option>
                        <optgroup label="Existing Genres">
                            ${configuredGenres.map(genre => 
                                `<option value="existing:${genre}" ${genre === currentGenre ? 'selected' : ''}>${genre}</option>`
                            ).join('')}
                        </optgroup>
                    </select>
                </div>`;
            
            // Store the original content and update
            const originalContent = suggestionCell.innerHTML;
            console.log('Original content:', originalContent);
            console.log('New content:', selectHtml);
            suggestionCell.innerHTML = selectHtml;
            
            // Add event listeners
            const select = suggestionCell.querySelector('.edit-genre-select');
            if (!select) {
                console.error('Failed to find select element');
                return;
            }
            
            select.addEventListener('change', async (e) => {
                console.log('Select changed');
                e.preventDefault();
                e.stopPropagation();
                
                const selectedValue = select.value;
                console.log('Selected value:', selectedValue);
                if (!selectedValue) {
                    return;
                }
                
                if (selectedValue === 'new:custom') {
                    const newGenre = prompt('Enter new genre name:');
                    if (!newGenre) {
                        select.value = currentGenre;
                        return;
                    }
                    
                    try {
                        await addNewGenre(newGenre);
                        // Update the movie's genre
                        suggestionCell.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="me-2">${newGenre}</span>
                                <button type="button" class="btn btn-link btn-sm p-0 edit-suggestion-button" 
                                    data-movie-path="${button.dataset.moviePath}"
                                    data-base-folder="${button.dataset.baseFolder}"
                                    data-current-genre="${newGenre}"
                                    data-index="${index}">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </div>`;
                        
                        // Update actions cell
                        updateActionsCell(index, newGenre);
                        
                        // Reattach event listener
                        const newButton = suggestionCell.querySelector('.edit-suggestion-button');
                        if (newButton) {
                            newButton.addEventListener('click', function() {
                                console.log('Edit button clicked!');
                                showGenreEditForm(this);
                            });
                        }
                    } catch (error) {
                        console.error('Error adding new genre:', error);
                        alert('Failed to add new genre. Please try again.');
                        select.value = currentGenre;
                    }
                } else {
                    const [type, genre] = selectedValue.split(':');
                    suggestionCell.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="me-2">${genre}</span>
                            <button type="button" class="btn btn-link btn-sm p-0 edit-suggestion-button" 
                                data-movie-path="${button.dataset.moviePath}"
                                data-base-folder="${button.dataset.baseFolder}"
                                data-current-genre="${genre}"
                                data-index="${index}">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>`;
                    
                    // Update actions cell
                    updateActionsCell(index, genre);
                    
                    // Reattach event listener
                    const newButton = suggestionCell.querySelector('.edit-suggestion-button');
                    if (newButton) {
                        newButton.addEventListener('click', function() {
                            console.log('Edit button clicked!');
                            showGenreEditForm(this);
                        });
                    }
                }
                
                return false;
            });
            
            // Focus the select to show dropdown immediately
            select.focus();
        }
        
        function updateActionsCell(index, newGenre) {
            const actionsCell = document.getElementById(`actions-${index}`);
            const currentGenre = document.getElementById(`current-genre-${index}`).textContent.trim();
            
            if (currentGenre.toLowerCase() !== newGenre.toLowerCase()) {
                const moviePath = document.getElementById(`movie-path-${index}`).value;
                const baseFolder = document.getElementById(`base-folder-${index}`).value;
                
                actionsCell.innerHTML = `
                    <button type="button" class="btn btn-success btn-sm move-button" 
                        data-path="${moviePath}" 
                        data-base-folder="${baseFolder}" 
                        data-genre="${newGenre}">
                        <span class="button-text">Move to ${newGenre}</span>
                        <div class="spinner-border spinner-border-sm d-none" role="status">
                            <span class="visually-hidden">Moving...</span>
                        </div>
                        <span class="retry-text d-none">Try again</span>
                    </button>`;
                
                // Attach event listener to new move button
                const moveButton = actionsCell.querySelector('.move-button');
                moveButton.addEventListener('click', function() {
                    const { path, baseFolder, genre } = this.dataset;
                    moveMovie(path, baseFolder, genre);
                });
            } else {
                actionsCell.innerHTML = '';
            }
        }
        
        function attachEventListeners() {
            console.log('Attaching all event listeners');
            
            // Remove existing event listeners by cloning and replacing elements
            document.querySelectorAll('.suggestion-button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    getGenreSuggestion(this);
                });
            });
            
            document.querySelectorAll('.move-button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    const { path, baseFolder, genre } = this.dataset;
                    moveMovie(path, baseFolder, genre);
                });
            });
            
            document.querySelectorAll('.genre-selection select').forEach(select => {
                const newSelect = select.cloneNode(true);
                select.parentNode.replaceChild(newSelect, select);
                newSelect.addEventListener('change', function() {
                    handleGenreSelection(this);
                });
            });
            
            // Attach edit button listeners
            console.log('Looking for edit buttons');
            const editButtons = document.querySelectorAll('.edit-suggestion-button');
            console.log('Found edit buttons:', editButtons.length);
            editButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                console.log('Found edit button:', newButton);
                console.log('Button dataset:', newButton.dataset);
                newButton.addEventListener('click', function(e) {
                    console.log('Edit button clicked!');
                    console.log('Button data:', this.dataset);
                    e.preventDefault();
                    e.stopPropagation();
                    showGenreEditForm(this);
                });
            });
        }
        
        // Initial event listener attachment
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - attaching listeners');
            attachEventListeners();
        });
        
        // Initialize tooltips
        function initializeTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl, {
                    trigger: 'click',
                    html: true
                });
            });

            // Hide tooltip when clicking anywhere else
            document.addEventListener('click', function (event) {
                if (!event.target.closest('[data-bs-toggle="tooltip"]')) {
                    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                        const tooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                        if (tooltip) {
                            tooltip.hide();
                        }
                    });
                }
            });

            // Hide other tooltips when showing a new one
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                tooltipTriggerEl.addEventListener('show.bs.tooltip', function () {
                    tooltipTriggerList.forEach(function (otherTriggerEl) {
                        if (otherTriggerEl !== tooltipTriggerEl) {
                            const tooltip = bootstrap.Tooltip.getInstance(otherTriggerEl);
                            if (tooltip) {
                                tooltip.hide();
                            }
                        }
                    });
                });
            });
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTooltips();
        });
    </script>
    
    <!-- Hidden inputs for movie data -->
    {% for movie in movies %}
    <input type="hidden" id="movie-path-{{ loop.index }}" value="{{ movie.path }}">
    <input type="hidden" id="base-folder-{{ loop.index }}" value="{{ selected_folder }}">
    {% endfor %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% endif %}
</body>
</html>
